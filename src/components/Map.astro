---
import type {} from "../types/google-maps";

const apiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;
---

<div class="w-full h-1/2 md:h-screen" id="map"></div>

<script
  async
  defer
  src={`https://maps.googleapis.com/maps/api/js?key=${apiKey}&loading=async&callback=initMap`}
></script>

<script>
  import { airports, mapCenter, mapStyles } from "../data/airports";
  import { trips as tripData } from "../data/trips";

  const ICON_URL = "https://jacobproffer.github.io/airports/img/marker.svg";

  interface MarkerOptions {
    position: google.maps.LatLng;
    sidebarItem?: string;
    content?: string;
    sidebarItemType?: string;
    sidebarItemClassName?: string;
  }

  interface SidebarItemInstance {
    button: HTMLElement;
    listItem: HTMLElement;
    div: HTMLElement | null;
    addIn(block: string | HTMLElement): void;
    remove(): boolean;
  }

  function initializeMap(): void {
    const mapElement = document.getElementById("map");
    if (!mapElement) {
      console.error("Map element not found");
      return;
    }

    const map = new google.maps.Map(mapElement, {
      zoom: 3,
      center: mapCenter,
      styles: mapStyles,
    });

    const markerBounds = new google.maps.LatLngBounds();
    const infoWindow = new google.maps.InfoWindow();
    const markerCollection: google.maps.Marker[] = [];

    // Close info windows when clicking outside the map or sidebar
    document.addEventListener("click", (event) => {
      if (
        event.target &&
        event.target instanceof Element &&
        !event.target.closest("#map") &&
        !event.target.closest(".sidebar-item")
      ) {
        infoWindow.close();
      }
    });

    // Close info window when clicking on the map
    google.maps.event.addListener(map, "click", () => {
      infoWindow.close();
    });

    // Create sidebar items for markers
    class SidebarItem implements SidebarItemInstance {
      button: HTMLElement;
      listItem: HTMLElement;
      div: HTMLElement | null = null;

      constructor(
        marker: google.maps.Marker,
        opts: {
          sidebarItem?: string;
          sidebarItemType?: string;
          sidebarItemClassName?: string;
        }
      ) {
        // Create list item wrapper
        this.listItem = document.createElement("li");

        // Create button element
        const tag = opts.sidebarItemType || "button";
        const button = document.createElement(tag);
        button.innerHTML = opts.sidebarItem || "";
        button.className =
          opts.sidebarItemClassName ||
          "py-2 px-3 bg-black border border-yellow cursor-pointer transition-colors duration-200 sidebar-item w-full text-left text-white hover:bg-yellow hover:text-black focus:outline-dashed focus:outline-2 focus:outline-offset-2 focus:outline-yellow";
        button.onclick = () => google.maps.event.trigger(marker, "click");
        button.onmouseover = () =>
          google.maps.event.trigger(marker, "mouseover");
        button.onmouseout = () => google.maps.event.trigger(marker, "mouseout");

        // Append button to list item
        this.listItem.appendChild(button);
        this.button = button;
      }

      addIn(block: string | HTMLElement): void {
        if (block && typeof block !== "string" && block.nodeType === 1) {
          this.div = block as HTMLElement;
        } else {
          this.div =
            document.getElementById(block as string) ||
            document.getElementById("sidebar") ||
            document.getElementsByTagName("body")[0];
        }
        this.div.appendChild(this.listItem);
      }

      remove(): boolean {
        if (!this.div) return false;
        this.div.removeChild(this.listItem);
        return true;
      }
    }

    // Create markers for each airport
    function createMarker(options: MarkerOptions): google.maps.Marker {
      const marker = new google.maps.Marker({
        map,
        optimized: false,
        icon: {
          url: ICON_URL,
          scaledSize: new google.maps.Size(30, 30),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(15, 15),
        },
        ...options,
      });

      google.maps.event.addListener(marker, "click", () => {
        infoWindow.setOptions(options);
        infoWindow.open(map, marker);
        const sidebarButton = (marker as any)
          .sidebarButton as SidebarItemInstance;
        if (sidebarButton) {
          sidebarButton.button.focus();
        }
      });

      if (options.sidebarItem) {
        (marker as any).sidebarButton = new SidebarItem(marker, options);
        ((marker as any).sidebarButton as SidebarItemInstance).addIn("sidebar");
      }

      markerBounds.extend(options.position);
      markerCollection.push(marker);
      return marker;
    }

    // Add all airport markers
    airports.forEach(([lat, lng, content, code]) => {
      createMarker({
        position: new google.maps.LatLng(lat, lng),
        sidebarItem: code,
        content,
      });
    });

    // Draw trip routes
    function drawTripLine(coordinates: { lat: number; lng: number }[]): void {
      const path = coordinates.map(
        (coord) => new google.maps.LatLng(coord.lat, coord.lng)
      );
      new google.maps.Polyline({
        path,
        strokeColor: "#677279",
        strokeOpacity: 0.2,
        strokeWeight: 3,
        geodesic: true,
        map,
      });
    }

    // Draw all trip routes
    Object.values(tripData).forEach((trip) => {
      drawTripLine(trip);
    });
  }

  // Make initMap globally available for Google Maps callback
  window.initMap = initializeMap;

  // Also ensure it runs when DOM is loaded if Google Maps is already available
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof (window as any).google !== "undefined") {
        initializeMap();
      }
    });
  } else if (typeof (window as any).google !== "undefined") {
    initializeMap();
  }
</script>
